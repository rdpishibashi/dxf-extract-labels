# DXF Extract Labels

DXFファイルからテキストラベルを抽出し、Excel形式で出力するStreamlitアプリケーションです。

## 機能

- **複数ファイル対応**: 複数のDXFファイルを一括処理
- **ラベル抽出**: DXFファイルからTEXT、MTEXTエンティティを抽出
- **機器符号フィルタリング**: 回路記号（機器符号）のみを抽出する高度なフィルタリング
- **妥当性チェック**: 標準フォーマットとの適合性をチェック
- **図面番号抽出**: 図番と流用元図番を自動識別（ラベルベース・座標ベース）
- **タイトル・サブタイトル抽出**: 図面のタイトルとサブタイトルを自動抽出
- **複数図面対応**: 1ファイルに複数図面がある場合、最も右側の図面を対象
- **レイヤー選択**: 特定のレイヤーのみを処理対象とする機能
- **Excel出力**: 統計情報とラベル一覧をExcel形式で出力
- **自動集計**: ファイルごとの個別シートとサマリーシートを生成

## インストール

### ローカル開発環境

1. このリポジトリをクローンまたはダウンロード
2. 依存関係をインストール:
   ```bash
   pip install -r requirements.txt
   ```
3. アプリケーションを実行:
   ```bash
   streamlit run app.py
   ```

### Streamlit Cloud へのデプロイ

1. このリポジトリをGitHubにプッシュ
2. Streamlit Cloudに接続
3. 以下の設定でデプロイ:
   - **メインファイルパス**: `app.py`
   - **Pythonバージョン**: 3.9以上
   - **要件ファイル**: `requirements.txt`

## 使用方法

### 基本的なワークフロー

1. **ファイルのアップロード**: 複数のDXFファイルをアップロード可能
   - ドラッグ&ドロップまたはファイル選択
   - 複数ファイルの同時アップロード対応

2. **レイヤー選択** (任意):
   - 「特定のレイヤーのみを処理する」オプションを有効化
   - 処理対象とするレイヤーを選択

3. **オプション設定** (任意):
   - **機器符号フィルタリング**: 回路記号のみを抽出
     - 基本パターン: `CNCNT`, `FB`
     - 英文字+数字: `R10`, `CN3`, `PSW1`
     - 英文字+数字+英文字: `X14A`, `RMSS2A`
     - 括弧付きパターン: `FB()`, `MSS(MOTOR)`, `R10(2.2K)`
   - **機器符号妥当性チェック**: 標準フォーマットとの適合性をチェック
   - **図面番号抽出**: 図番と流用元図番を自動識別
   - **並び替え**: 昇順、降順、並び替えなしを選択

4. **ファイル処理**: 「ラベルを抽出」ボタンをクリックして抽出開始

5. **結果のダウンロード**: Excelファイルをダウンロード

### 出力ファイル

デフォルトのExcelファイル名: `extracted_labels.xlsx`

Excelファイルの構成:
- **Summaryシート**: 全ファイルの抽出結果概要
  - ファイル名、総抽出数、フィルタリング除外数、最終ラベル数
  - 処理レイヤー数、全レイヤー数
  - 図番、流用元図番（図面番号抽出が有効な場合）
  - タイトル、サブタイトル（抽出された場合）
- **各ファイルシート**: 個別ファイルの抽出ラベル一覧
- **Invalidシート** (妥当性チェック有効時): 適合しない機器符号一覧

## 技術詳細

### 対象となるDXFエンティティ

- **TEXT**: 単行テキスト
- **MTEXT**: 複数行テキスト（フォーマットコード除去処理付き）
- **INSERT**: ブロック参照内のテキスト
- **MODEL_SPACE**: モデル空間内のテキスト
- **PAPER_SPACE**: ペーパー空間内のテキスト

### 機器符号フィルタリング

以下のパターンに一致するラベルを機器符号として認識:

1. **英文字のみ** (2文字以上): `FB`, `CNCNT`
2. **英文字+数字**: `R10`, `CN3`, `PSW1`
3. **英文字+数字+英文字**: `X14A`, `RMSS2A`
4. **括弧付きバリエーション**: `FB()`, `MSS(MOTOR)`, `R10(2.2K)`, `U23B(DAC)`

### 機器符号妥当性チェック

標準的な機器符号パターンとの適合性をチェック:
- **CB系**: `CB001`, `ELB(CB)001`, `MCCB001`, `NFB001`
- **基本部品**: `R`, `R1`, `C1`, `L1`, `Q1`
- **IC**: `U`, `U1`, `U10A`
- **電源**: `PS`, `PSW`, `DC1`, `AC1`
- **モータ**: `M`, `M1`, `MOT1`
- **リレー**: `K`, `K1`, `MC1`
- **スイッチ**: `S`, `S1`, `SW1`, `PB1`
- **表示**: `H`, `H1`, `HL1`, `PL1`
- **端子**: `X`, `X1`, `CN1`, `TB1`

### 図面番号・タイトル抽出

#### 図面番号の抽出
図面番号フォーマット: `XX0000-000-00X` (例: `DE5313-008-02B`)

1. **ラベルベース検出**（優先）
   - 「DWG No.」ラベルから80単位以内の図面番号を検出
   - 「流用元図番」ラベルから80単位以内の図面番号を検出
   - ファイル名との一致も考慮

2. **座標ベース検出**（フォールバック）
   - 複数図面が1ファイルにある場合、最も右側の図面（X座標が最大±100単位以内）のみを対象
   - 最も右下にある図面番号を「図番」として識別
   - 2番目に座標値が大きい図面番号を「流用元図番」として識別

#### タイトル・サブタイトルの抽出
- 「TITLE」ラベルから横方向80単位以内のテキストを抽出
- タイトル: TITLEラベルと同じ高さのテキスト
- サブタイトル: タイトルの下の行のテキスト

### 高度な機能

1. **MTEXTフォーマット処理**:
   - フォーマット制御コード (`\f`, `\H`, `\W`, `\C` など) を自動除去
   - 日本語環境での円マーク (`¥`) とバックスラッシュ (`\`) の正規化
   - テキスト構造 (`\P`) は保持

2. **高精度テキスト抽出**:
   - 複数行テキストの正確な処理
   - エスケープ文字の適切な処理
   - ブロック参照内のテキストの抽出

3. **柔軟な出力設定**:
   - カスタマイズ可能な出力ファイル名
   - 統計情報の自動生成
   - レイヤー別の処理制御

## 依存関係

- **streamlit** >= 1.30.0: ウェブアプリケーションフレームワーク
- **ezdxf** >= 1.4.2: DXFファイルの読み書き
- **pandas** >= 1.5.0: データ分析・処理
- **xlsxwriter** >= 3.0.0: Excel ファイル生成

## システム要件

- Python 3.9 以上
- 最小 512MB RAM (一般的なDXFファイルの場合)
- JavaScriptが有効な最新のウェブブラウザ

## 制限事項

- DXFファイルはezdxfライブラリで読み取り可能である必要があります
- 非常に大きなファイル (>100MB) はクラウドプラットフォームでメモリ問題を引き起こす可能性があります

## トラブルシューティング

### よくある問題

1. **「DXFファイルの読み取りエラー」**:
   - ファイルが有効なDXF形式であることを確認
   - ファイルが破損またはパスワード保護されていないか確認

2. **「ラベルが抽出されない」**:
   - TEXTまたはMTEXTエンティティが含まれているか確認
   - レイヤー選択が適切に設定されているか確認
   - 機器符号フィルタリングが適切に設定されているか確認

3. **「処理タイムアウト」**:
   - 大きいまたは複雑なファイルは処理に時間がかかる場合があります
   - ファイル数を減らしてみてください

4. **「機器符号が認識されない」**:
   - フィルタリングパターンを確認してください
   - 妥当性チェックを無効にして試してみてください

### サポート

技術サポートやバグレポートについては、アプリケーションログを確認するか、開発チームにお問い合わせください。

## DXF-label-diffとの違い

- **DXF-label-diff**: 2つのDXFファイルのラベルを比較し、差分を抽出
- **DXF-extract-labels**: 単一または複数のDXFファイルからラベルを抽出

両プロジェクトは同じコアライブラリ（`extract_labels.py`、`common_utils.py`）を共有しています。

## ライセンス

このアプリケーションは 株式会社RDPi 所有であり特定顧客向けに開発されています。コピーや改版は禁止されています。

## バージョン履歴

- **v1.1.0**: 図面番号抽出とタイトル抽出の改善
  - タイトル・サブタイトル自動抽出機能を追加
  - ラベルベース図面番号検出を追加（80単位の近接検出）
  - 複数図面対応（最も右側の図面を自動選択）
  - 座標ベース検出の精度向上
  - Excel出力にTitle、Subtitleカラムを追加

- **v1.0.0**: DXFラベル抽出機能を備えた初回リリース
  - 複数ファイル対応
  - 機器符号フィルタリング機能
  - 機器符号妥当性チェック機能
  - 図面番号抽出機能
  - レイヤー選択機能
  - Excel形式での出力
